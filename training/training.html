<!doctype html>
<html lang="en">
<head>
<title>Data Engineering Training Materials</title>
<!-- 2020-12-09 Wed 10:39 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="generator" content="Org-mode">

<link  href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.5/js/bootstrap.min.js"></script>
<style>
/* org mode styles on top of twbs */

html {
    position: relative;
    min-height: 100%;
}

body {
    font-size: 18px;
    margin-bottom: 105px;
}

footer {
    position: absolute;
    bottom: 0;
    width: 100%;
    height: 101px;
    background-color: #f5f5f5;
}

footer > div {
    padding: 10px;
}

footer p {
    margin: 0 0 5px;
    text-align: center;
    font-size: 16px;
}

#table-of-contents {
    margin-top: 20px;
    margin-bottom: 20px;
}

blockquote p {
    font-size: 18px;
}

pre {
    font-size: 16px;
}

.footpara {
    display: inline-block;
}

figcaption {
  font-size: 16px;
  color: #666;
  font-style: italic;
  padding-bottom: 15px;
}

/* from twbs docs */

.bs-docs-sidebar.affix {
    position: static;
}
@media (min-width: 768px) {
    .bs-docs-sidebar {
        padding-left: 20px;
    }
}

/* All levels of nav */
.bs-docs-sidebar .nav > li > a {
    display: block;
    padding: 4px 20px;
    font-size: 14px;
    font-weight: 500;
    color: #999;
}
.bs-docs-sidebar .nav > li > a:hover,
.bs-docs-sidebar .nav > li > a:focus {
    padding-left: 19px;
    color: #A1283B;
    text-decoration: none;
    background-color: transparent;
    border-left: 1px solid #A1283B;
}
.bs-docs-sidebar .nav > .active > a,
.bs-docs-sidebar .nav > .active:hover > a,
.bs-docs-sidebar .nav > .active:focus > a {
    padding-left: 18px;
    font-weight: bold;
    color: #A1283B;
    background-color: transparent;
    border-left: 2px solid #A1283B;
}

/* Nav: second level (shown on .active) */
.bs-docs-sidebar .nav .nav {
    display: none; /* Hide by default, but at >768px, show it */
    padding-bottom: 10px;
}
.bs-docs-sidebar .nav .nav > li > a {
    padding-top: 1px;
    padding-bottom: 1px;
    padding-left: 30px;
    font-size: 12px;
    font-weight: normal;
}
.bs-docs-sidebar .nav .nav > li > a:hover,
.bs-docs-sidebar .nav .nav > li > a:focus {
    padding-left: 29px;
}
.bs-docs-sidebar .nav .nav > .active > a,
.bs-docs-sidebar .nav .nav > .active:hover > a,
.bs-docs-sidebar .nav .nav > .active:focus > a {
    padding-left: 28px;
    font-weight: 500;
}

/* Nav: third level (shown on .active) */
.bs-docs-sidebar .nav .nav .nav {
    padding-bottom: 10px;
}
.bs-docs-sidebar .nav .nav .nav > li > a {
    padding-top: 1px;
    padding-bottom: 1px;
    padding-left: 40px;
    font-size: 12px;
    font-weight: normal;
}
.bs-docs-sidebar .nav .nav .nav > li > a:hover,
.bs-docs-sidebar .nav .nav .nav > li > a:focus {
    padding-left: 39px;
}
.bs-docs-sidebar .nav .nav .nav > .active > a,
.bs-docs-sidebar .nav .nav .nav > .active:hover > a,
.bs-docs-sidebar .nav .nav .nav > .active:focus > a {
    padding-left: 38px;
    font-weight: 500;
}

/* Show and affix the side nav when space allows it */
@media (min-width: 992px) {
    .bs-docs-sidebar .nav > .active > ul {
        display: block;
    }
    /* Widen the fixed sidebar */
    .bs-docs-sidebar.affix,
    .bs-docs-sidebar.affix-bottom {
        width: 213px;
    }
    .bs-docs-sidebar.affix {
        position: fixed; /* Undo the static from mobile first approach */
        top: 20px;
    }
    .bs-docs-sidebar.affix-bottom {
        position: absolute; /* Undo the static from mobile first approach */
    }
    .bs-docs-sidebar.affix .bs-docs-sidenav,.bs-docs-sidebar.affix-bottom .bs-docs-sidenav {
        margin-top: 0;
        margin-bottom: 0
    }
}
@media (min-width: 1200px) {
    /* Widen the fixed sidebar again */
    .bs-docs-sidebar.affix-bottom,
    .bs-docs-sidebar.affix {
        width: 263px;
    }
}
</style>
<script>
$(function() {
    'use strict';

    $('.bs-docs-sidebar li').first().addClass('active');

    $(document.body).scrollspy({target: '.bs-docs-sidebar'});

    $('.bs-docs-sidebar').affix();
});
</script>
</head>
<body>
<div id="content" class="container">
<div class="row"><div class="col-md-3 col-md-push-9"><nav id="table-of-contents">
<div id="text-table-of-contents" class="bs-docs-sidebar">
<ul class="nav">
<li><a href="#sec-1">1. Introduction</a></li>
<li><a href="#sec-2">2. COVID Data</a>
<ul class="nav">
<li><a href="#sec-2-1">2.1. Cases and deaths</a></li>
<li><a href="#sec-2-2">2.2. Hospitalizations</a></li>
<li><a href="#sec-2-3">2.3. Tests</a></li>
</ul>
</li>
<li><a href="#sec-3">3. Scraper Infrastructure</a></li>
<li><a href="#sec-4">4. Database</a>
<ul class="nav">
<li><a href="#sec-4-1">4.1. <code>data.covid_official</code></a></li>
<li><a href="#sec-4-2">4.2. <code>meta.covid_variables</code></a></li>
<li><a href="#sec-4-3">4.3. <code>data.covid_providers</code></a></li>
</ul>
</li>
<li><a href="#sec-5">5. Getting Started, Development Notes</a>
<ul class="nav">
<li><a href="#sec-5-1">5.1. Creating a development environment</a></li>
<li><a href="#sec-5-2">5.2. Running tests locally</a></li>
<li><a href="#sec-5-3">5.3. Setting up VS Code</a></li>
</ul>
</li>
<li><a href="#sec-6">6. Scraper Library</a>
<ul class="nav">
<li><a href="#sec-6-1">6.1. <code>DatasetBase</code> and relevant subclasses</a></li>
</ul>
</li>
<li><a href="#sec-7">7. Writing a new scraper</a></li>
<li><a href="#sec-8">8. Example Scrapers</a></li>
</ul>
</div>
</nav>
</div><div class="col-md-9 col-md-pull-3"><h1 class="title">Data Engineering Training Materials</h1>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Introduction</h2>
<div class="outline-text-2" id="text-1">
<p>
All of the code and documentation for the Covid Act Now (CAN) scrapers, including this document, is in the <a href="https://github.com/covid-projections/can-scrapers">can-scrapers</a> Github repository. We will refer to various folders within this repository throughout this document.
</p>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> COVID Data</h2>
<div class="outline-text-2" id="text-2">
</div><div id="outline-container-sec-2-1" class="outline-3">
<h3 id="sec-2-1"><span class="section-number-3">2.1</span> Cases and deaths</h3>
<div class="outline-text-3" id="text-2-1">
<p>
Case data can be split into two categories
</p>

<ol class="org-ol">
<li><i>Confirmed cases|deaths</i>: This typically refers to individuals who have tested positive for COVID (typically via a <a href="#PCR test">1</a>)
</li>
<li><i>Suspected (Probable) cases|deaths</i>: This refers to an individual, one who was typically hospitalized, who had many of the symptoms associated with COVID but that had not been administered a test to confirm the diagnosis. This variable definition was especially relevant early in the pandemic when there was not wide-spread testing.
</li>
</ol>

<p>
In our work, we will mostly focus on <i>total cases|deaths</i> which includes the sum of confirmed and suspected cases|deaths &#x2013; This is because now that we have wide-spread testing, there are fewer suspected cases because they can easily be confirmed
</p>
</div>
</div>

<div id="outline-container-sec-2-2" class="outline-3">
<h3 id="sec-2-2"><span class="section-number-3">2.2</span> Hospitalizations</h3>
</div>
<div id="outline-container-sec-2-3" class="outline-3">
<h3 id="sec-2-3"><span class="section-number-3">2.3</span> Tests</h3>
<div class="outline-text-3" id="text-2-3">
</div><div id="outline-container-sec-2-3-1" class="outline-4">
<h4 id="sec-2-3-1"><span class="section-number-4">2.3.1</span> Test types</h4>
<div class="outline-text-4" id="text-2-3-1">
<p>
There are three main kinds of tests antibody, antigen, and molecular. Antigen and molecular are both types of diagnostic tests and we'll group them together for our explanation below:
</p>
</div>

<ol class="org-ol"><li><a id="sec-2-3-1-1" name="sec-2-3-1-1"></a>Antibody tests<br ><div class="outline-text-5" id="text-2-3-1-1">
<p>
Antibody tests, also known as serology tests, are described by the <a href="https://www.fda.gov/consumers/consumer-updates/coronavirus-disease-2019-testing-basics">FDA</a> as,
</p>

<blockquote>
<p>
An antibody test looks for antibodies that are made by your immune system in response to a threat, such as a specific virus. Antibodies can help fight infections. Antibodies can take several days or weeks to develop after you have an infection and may stay in your blood for several weeks or more after recovery. Because of this, antibody tests should not be used to diagnose COVID-19. At this time researchers do not know if the presence of antibodies means that you are immune to COVID-19 in the future.
</p>
</blockquote>
</div>
</li>

<li><a id="sec-2-3-1-2" name="sec-2-3-1-2"></a>Diagnostic tests<br ><div class="outline-text-5" id="text-2-3-1-2">
<p>
Diagnostic tests are themselves broken into two sub-categories:
</p>

<ol class="org-ol">
<li>Molecular tests (in COVID context, often called a PCR test) <a id="PCR test" name="PCR test"></a>
</li>
<li>Antigen tests
</li>
</ol>

<p>
Diagnostic tests are described by the <a href="https://www.fda.gov/consumers/consumer-updates/coronavirus-disease-2019-testing-basics">FDA</a> as,
</p>

<blockquote>
<p>
A diagnostic test can show if you have an active coronavirus infection and should take steps to quarantine or isolate yourself from others. Currently there are two types of diagnostic tests– molecular tests, such as RT-PCR tests, that detect the virus’s genetic material, and antigen tests that detect specific proteins from the virus.
</p>
</blockquote>
</div>
</li></ol>
</div>

<div id="outline-container-sec-2-3-2" class="outline-4">
<h4 id="sec-2-3-2"><span class="section-number-4">2.3.2</span> Measurements</h4>
<div class="outline-text-4" id="text-2-3-2">
<p>
There has been a significant amount of confusion about the units that testing data is being reported in, see <a href="https://covidtracking.com/blog/test-positivity-in-the-us-is-a-mess">the COVID Tracking Project's blog post</a> on the topic. There are three main ways that COVID testing data is measured,
</p>

<ol class="org-ol">
<li>Specimens tested: The number of specimens that the labs collected/tested in a given geography
</li>
<li>Test encounters: The number of unique people tested in a particular day for a given geography
</li>
<li>Unique people: The number of unique people ever tested for a given geography
</li>
</ol>

<p>
Lets work through an example so we can be specific about the difference:
</p>

<p>
Imagine that Alice and Bob both go to get tested on April 1, 2020. Two specimen samples are collected from Alice and two specimen samples are collected from Bob. Alice and Bob then go to a Memorial Day celebration at the end of May and find out that the host tested COVID positive so they both go to get tested again on June 1, 2020. An additional two specimens are collected from both Alice and Bob.
</p>

<ul class="org-ul">
<li>How many specimens do Alice and Bob contribute to the total? Both Alice and Bob would contribute two specimens from April and two specimens from June for a total of <b>eight specimens</b>.
</li>
<li>How many test encounters do Alice and Bob contribute to the total? Both Alice and Bob would contribute a single test encounter from April and a single test encounter from June for a total of <b>four test encounters</b>.
</li>
<li>How many unique people do Alice and Bob contribute to the total? Although Alice and Bob were each tested twice, they are the same person in April and June, so they would only contribute <b>two unique people</b> to the total.
</li>
</ul>

<p>
The preferred metric at CAN is (currently) to count PCR test encounters. This will not always be available so its important that we collect whatever is available even if it isn't what we "want".
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> Scraper Infrastructure</h2>
<div class="outline-text-2" id="text-3">
<p>
The overall microservice architecture we use is shown in the diagram below:
</p>


<figure id="fig:IFC">
<p><img src="https://raw.githubusercontent.com/covid-projections/can-scrapers/33268d564f9d8b62d927ffa63d3d844a92b0efeb/docs/infrastructure/can_scrapers_overview.png" class="img-responsive" alt="can_scrapers_overview.png">
</p>
<figcaption><span class="figure-number">Figure 1:</span> Infrastructure flow chart</figcaption>
</figure>

<p>
In, words, these components are:
</p>

<ol class="org-ol">
<li>Scrapers: these are open source scrapers written in Python. The repository is here <a href="https://github.com/covid-projections/can-scrapers">https://github.com/covid-projections/can-scrapers</a>
</li>
<li>Database: we store all data in a postgrestql database
</li>
<li>API: We have REST and GraphQL APIs. They are automatically generated using the PostgREST and postgraphile libraries
</li>
<li>Client Libraries: We have client libraries in Python, R, and Julia that integrate with the REST API
</li>
<li>API Gateway: we have a Kong API gateway that sits in front of all user requests and handles things like caching, routing, and authentication
</li>
<li>Other services: we have a handful of other microservices that perform specific functions. These are contained in docker containers that communicate over HTTP and are managed by Google Cloud run
</li>
</ol>
</div>
</div>


<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> Database</h2>
<div class="outline-text-2" id="text-4">
<p>
All of the data that is collected is stored in a PostgreSQL database hosted on
Google Cloud. This database is structured in three schemas:
</p>

<ol class="org-ol">
<li><code>api</code> : This is the public facing schema. It does not contain any tables
itself but rather contains views and materialized views
</li>
<li><code>data</code> : This schema is where data that is collected is stored
</li>
<li><code>meta</code> : This schema contains meta information about geographies and
variables. It is information that will only be changed/updated infrequently.
</li>
</ol>
</div>

<div id="outline-container-sec-4-1" class="outline-3">
<h3 id="sec-4-1"><span class="section-number-3">4.1</span> <code>data.covid_official</code></h3>
<div class="outline-text-3" id="text-4-1">
<p>
The web scrapers we write place data in the table <code>data.covid_official</code>
</p>

<p>
We'll review this table and then fill in the details on the foreign key
relationships
</p>

<div class="org-src-container">

<pre class="src src-sql"><span style="color: #FF80BF; font-weight: bold;">CREATE</span> <span style="color: #FF80BF; font-weight: bold;">TABLE</span> <span style="color: #FF80BF; font-weight: bold;">data</span>.covid_official
<span style="color: #f8f8f2;">(</span>
    vintage <span style="color: #9580FF;">TIMESTAMP</span>,
    dt <span style="color: #9580FF;">DATE</span>,
    location_id BIGINT <span style="color: #FF80BF; font-weight: bold;">REFERENCES</span> meta.locations <span style="color: #80FFEA;">(</span>id<span style="color: #80FFEA;">)</span>,
    variable_id <span style="color: #9580FF;">SMALLINT</span> <span style="color: #FF80BF; font-weight: bold;">REFERENCES</span> meta.covid_variables <span style="color: #80FFEA;">(</span>id<span style="color: #80FFEA;">)</span>,
    demographic_id <span style="color: #9580FF;">SMALLINT</span> <span style="color: #FF80BF; font-weight: bold;">REFERENCES</span> meta.covid_demographics <span style="color: #80FFEA;">(</span>id<span style="color: #80FFEA;">)</span>,
    <span style="color: #FF80BF; font-weight: bold;">value</span> <span style="color: #9580FF;">REAL</span>,
    provider <span style="color: #9580FF;">INT</span> <span style="color: #FF80BF; font-weight: bold;">REFERENCES</span> <span style="color: #FF80BF; font-weight: bold;">data</span>.covid_providers <span style="color: #80FFEA;">(</span>id<span style="color: #80FFEA;">)</span> <span style="color: #FF80BF; font-weight: bold;">NOT</span> <span style="color: #FF80BF; font-weight: bold;">NULL</span>,
    <span style="color: #FF80BF; font-weight: bold;">PRIMARY</span> <span style="color: #FF80BF; font-weight: bold;">KEY</span> <span style="color: #80FFEA;">(</span>vintage, dt, location_id, variable_id, demographic_id<span style="color: #80FFEA;">)</span>
<span style="color: #f8f8f2;">)</span>;
</pre>
</div>

<p>
<a href="../db/schemas/003_covid_individual_sources.sql#MissingReference">COVID File</a>
</p>

<p>
The foreign key relationships are
</p>

<ul class="org-ul">
<li>The <code>meta.locations</code> table keeps track of all "locations" in our database. For
US states and counties this includes the US FIPS code
</li>
<li>The <code>meta.covid_variables</code> table contains information on the variable, its
units, and form of measurement. We'll talk through this one in more detail
</li>
<li>The <code>meta.covid_demographics</code> contains information on the age, rage, ethnicity, 
and sex for individuals represented in the data observations.
</li>
<li><code>data.covid_providers</code> helps us keep track where this data comes from. We'll
look at this one also&#x2026;
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-4-2" class="outline-3">
<h3 id="sec-4-2"><span class="section-number-3">4.2</span> <code>meta.covid_variables</code></h3>
<div class="outline-text-3" id="text-4-2">
<div class="org-src-container">

<pre class="src src-sql"><span style="color: #FF80BF; font-weight: bold;">CREATE</span> <span style="color: #FF80BF; font-weight: bold;">TABLE</span> <span style="color: #8aFF80; font-weight: bold;">meta.covid_variables</span>
<span style="color: #f8f8f2;">(</span>
    id SERIAL <span style="color: #FF80BF; font-weight: bold;">PRIMARY</span> <span style="color: #FF80BF; font-weight: bold;">KEY</span>,
    category TEXT <span style="color: #FF80BF; font-weight: bold;">REFERENCES</span> meta.covid_categories <span style="color: #80FFEA;">(</span>subcategory<span style="color: #80FFEA;">)</span>,
    measurement TEXT <span style="color: #FF80BF; font-weight: bold;">REFERENCES</span> meta.covid_measurement <span style="color: #80FFEA;">(</span><span style="color: #FF80BF; font-weight: bold;">name</span><span style="color: #80FFEA;">)</span>,
    unit TEXT <span style="color: #FF80BF; font-weight: bold;">REFERENCES</span> meta.covid_unit <span style="color: #80FFEA;">(</span><span style="color: #FF80BF; font-weight: bold;">name</span><span style="color: #80FFEA;">)</span>
<span style="color: #f8f8f2;">)</span>;

<span style="color: #FF80BF; font-weight: bold;">INSERT</span> <span style="color: #FF80BF; font-weight: bold;">INTO</span> meta.covid_variables <span style="color: #f8f8f2;">(</span>category, measurement, unit<span style="color: #f8f8f2;">)</span>
<span style="color: #FF80BF; font-weight: bold;">VALUES</span> <span style="color: #f8f8f2;">(</span><span style="color: #FFFF80;">'cases'</span>, <span style="color: #FFFF80;">'cumulative'</span>, <span style="color: #FFFF80;">'people'</span><span style="color: #f8f8f2;">)</span>,
       <span style="color: #f8f8f2;">(</span><span style="color: #FFFF80;">'cases'</span>, <span style="color: #FFFF80;">'new'</span>, <span style="color: #FFFF80;">'people'</span><span style="color: #f8f8f2;">)</span>,
       <span style="color: #f8f8f2;">(</span><span style="color: #FFFF80;">'deaths'</span>, <span style="color: #FFFF80;">'cumulative'</span>, <span style="color: #FFFF80;">'people'</span><span style="color: #f8f8f2;">)</span>,
       <span style="color: #f8f8f2;">(</span><span style="color: #FFFF80;">'deaths'</span>, <span style="color: #FFFF80;">'new'</span>, <span style="color: #FFFF80;">'people'</span><span style="color: #f8f8f2;">)</span>,

       <span style="color: #f8f8f2;">(</span><span style="color: #FFFF80;">'hospital_beds_in_use_covid'</span>, <span style="color: #FFFF80;">'cumulative'</span>, <span style="color: #FFFF80;">'beds'</span><span style="color: #f8f8f2;">)</span>,
       <span style="color: #f8f8f2;">(</span><span style="color: #FFFF80;">'hospital_beds_in_use_covid'</span>, <span style="color: #FFFF80;">'new'</span>, <span style="color: #FFFF80;">'beds'</span><span style="color: #f8f8f2;">)</span>,

       <span style="color: #f8f8f2;">(</span><span style="color: #FFFF80;">'hospital_beds_in_use_covid'</span>, <span style="color: #FFFF80;">'current'</span>, <span style="color: #FFFF80;">'beds'</span><span style="color: #f8f8f2;">)</span>,
       <span style="color: #f8f8f2;">(</span><span style="color: #FFFF80;">'hospital_beds_in_use'</span>, <span style="color: #FFFF80;">'current'</span>, <span style="color: #FFFF80;">'beds'</span><span style="color: #f8f8f2;">)</span>,
       <span style="color: #f8f8f2;">(</span><span style="color: #FFFF80;">'hospital_beds_available'</span>, <span style="color: #FFFF80;">'current'</span>, <span style="color: #FFFF80;">'beds'</span><span style="color: #f8f8f2;">)</span>,
       <span style="color: #f8f8f2;">(</span><span style="color: #FFFF80;">'hospital_beds_capacity'</span>, <span style="color: #FFFF80;">'current'</span>, <span style="color: #FFFF80;">'beds'</span><span style="color: #f8f8f2;">)</span>,

       <span style="color: #f8f8f2;">(</span><span style="color: #FFFF80;">'adult_icu_beds_in_use'</span>, <span style="color: #FFFF80;">'current'</span>, <span style="color: #FFFF80;">'beds'</span><span style="color: #f8f8f2;">)</span>,
       <span style="color: #f8f8f2;">(</span><span style="color: #FFFF80;">'adult_icu_beds_in_use_covid'</span>, <span style="color: #FFFF80;">'current'</span>, <span style="color: #FFFF80;">'beds'</span><span style="color: #f8f8f2;">)</span>,
### many <span style="color: #FF80BF; font-weight: bold;">more</span> <span style="color: #FF80BF; font-weight: bold;">rows</span>!
</pre>
</div>

<p>
Let's look at the <a href="file:///home/sglyon/valorum/covid/can-scrapers/db/schemas/002_covid_data.sql#MissingReference">table</a>
</p>
</div>
</div>

<div id="outline-container-sec-4-3" class="outline-3">
<h3 id="sec-4-3"><span class="section-number-3">4.3</span> <code>data.covid_providers</code></h3>
<div class="outline-text-3" id="text-4-3">
<p>
Finally the <code>data.covid_providers</code> table
</p>

<div class="org-src-container">

<pre class="src src-sql"><span style="color: #FF80BF; font-weight: bold;">CREATE</span> <span style="color: #FF80BF; font-weight: bold;">TABLE</span> <span style="color: #FF80BF; font-weight: bold;">data</span>.covid_providers
<span style="color: #f8f8f2;">(</span>
    id SERIAL <span style="color: #FF80BF; font-weight: bold;">PRIMARY</span> <span style="color: #FF80BF; font-weight: bold;">KEY</span>,
    <span style="color: #FF80BF; font-weight: bold;">name</span> TEXT <span style="color: #FF80BF; font-weight: bold;">UNIQUE</span>,
    priority <span style="color: #9580FF;">INT</span>
<span style="color: #f8f8f2;">)</span>;


<span style="color: #FF80BF; font-weight: bold;">INSERT</span> <span style="color: #FF80BF; font-weight: bold;">INTO</span> <span style="color: #FF80BF; font-weight: bold;">data</span>.covid_providers <span style="color: #f8f8f2;">(</span><span style="color: #FF80BF; font-weight: bold;">name</span>, priority<span style="color: #f8f8f2;">)</span>
<span style="color: #FF80BF; font-weight: bold;">VALUES</span> <span style="color: #f8f8f2;">(</span><span style="color: #FFFF80;">'county'</span>, <span style="color: #80FFEA;">1000</span><span style="color: #f8f8f2;">)</span>,
       <span style="color: #f8f8f2;">(</span><span style="color: #FFFF80;">'state'</span>, <span style="color: #80FFEA;">2000</span><span style="color: #f8f8f2;">)</span>,
       <span style="color: #f8f8f2;">(</span><span style="color: #FFFF80;">'ny_times'</span>, <span style="color: #80FFEA;">2500</span><span style="color: #f8f8f2;">)</span>,
       <span style="color: #f8f8f2;">(</span><span style="color: #FFFF80;">'usafacts'</span>, <span style="color: #80FFEA;">3000</span><span style="color: #f8f8f2;">)</span>,
       <span style="color: #f8f8f2;">(</span><span style="color: #FFFF80;">'ctp'</span>, <span style="color: #80FFEA;">4000</span><span style="color: #f8f8f2;">)</span>,
       <span style="color: #f8f8f2;">(</span><span style="color: #FFFF80;">'hhs'</span>, <span style="color: #80FFEA;">5000</span><span style="color: #f8f8f2;">)</span>,
       <span style="color: #f8f8f2;">(</span><span style="color: #FFFF80;">'cdc'</span>, <span style="color: #80FFEA;">6000</span><span style="color: #f8f8f2;">)</span>
;
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5"><span class="section-number-2">5</span> Getting Started, Development Notes</h2>
<div class="outline-text-2" id="text-5">
</div><div id="outline-container-sec-5-1" class="outline-3">
<h3 id="sec-5-1"><span class="section-number-3">5.1</span> Creating a development environment</h3>
<div class="outline-text-3" id="text-5-1">
<ol class="org-ol">
<li>Install <code>conda</code> (either anaconda or miniconda)
</li>
<li>Create a conda environment for this project, <code>conda create -n can-scrapers python=3.6</code>
</li>
<li>Activate the environment, <code>conda activate can-scrapers</code>
</li>
<li>Move your command line or terminal into the <code>can-scrapers</code> directory
</li>
<li>Install the required packages, <code>pip install -r requirements-dev.txt</code>
</li>
<li>Install development version of the <code>can_tools</code> package, <code>pip install -e .</code>
</li>
</ol>
</div>
</div>

<div id="outline-container-sec-5-2" class="outline-3">
<h3 id="sec-5-2"><span class="section-number-3">5.2</span> Running tests locally</h3>
<div class="outline-text-3" id="text-5-2">
</div><div id="outline-container-sec-5-2-1" class="outline-4">
<h4 id="sec-5-2-1"><span class="section-number-4">5.2.1</span> Types of tests</h4>
<div class="outline-text-4" id="text-5-2-1">
<p>
We have written automated unit and integration tests using the <code>DatasetBase</code>
parent class.
</p>

<p>
The unit tests do the following:
</p>

<ul class="org-ul">
<li>Verify that the <code>fetch</code> method runs without any network errors
</li>
<li>Verify that the <code>normalize</code> method returns a DataFrame that
<ul class="org-ul">
<li>Is not empty
</li>
<li>Has the correct columns
</li>
</ul>
</li>
<li>The <code>validate</code> method runs without any issues and returns <code>True</code>
</li>
</ul>

<p>
The integration tests test that the <code>put</code> method can successfully load the
data into a test instance of the database (see below).
</p>

<p>
Our production environment uses PostgreSQL as the database engine.
</p>

<p>
All SQL interactions happen via sqlalchemy, which is (mostly) database
backend agnostic.
</p>

<p>
We can run integration tests either via an in-memory SQLite that is created
on each run of the tests, or against a running postgres instance.
</p>

<p>
Using SQLite while developing is encouraged as it is easier to get up and
running.
</p>

<p>
If you do choose to use PostgreSQL, please follow the instructions below for
using Docker to set up the instance of postgres.
</p>
</div>
</div>

<div id="outline-container-sec-5-2-2" class="outline-4">
<h4 id="sec-5-2-2"><span class="section-number-4">5.2.2</span> Local database instance using Docker</h4>
<div class="outline-text-4" id="text-5-2-2">
<p>
We use a docker based workflow for running a local instance of the database.
</p>

<p>
In order to utilize this workflow please start a postgresql container and
leave it running
</p>

<p>
Here's a sample <code>docker run</code> command that should do the trick
</p>

<div class="org-src-container">

<pre class="src src-shell">docker run --rm -d -p <span style="color: #80FFEA;">5432:5432</span> -e <span style="color: #f8f8f2; font-weight: bold;">POSTGRES_PASSWORD</span>=postgres_test postgres:12
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-2-3" class="outline-4">
<h4 id="sec-5-2-3"><span class="section-number-4">5.2.3</span> Running tests</h4>
<div class="outline-text-4" id="text-5-2-3">
<p>
To run the full suite of unit tests, execute the following from the root of
the <code>can-scrapers</code> repository:
</p>

<pre class="example">
pytest -v .
</pre>

<p>
Suppose you were working on a scraper for Wyoming and <code>Wyoming</code> was in the
name of the scraper class
</p>

<p>
To run tests only for <code>Wyoming</code> you could do
</p>

<pre class="example">
pytest -v -k Wyoming .
</pre>
</div>

<ol class="org-ol"><li><a id="sec-5-2-3-1" name="sec-5-2-3-1"></a>Extra: Using PostgreSQL<br ><div class="outline-text-5" id="text-5-2-3-1">
<p>
If you would like to run the integration tests against postgres, first
follow the instructions above to get an instance of postgres up and running
via docker
</p>

<p>
Then you need to set the environment variable <code>CAN_PG_CONN_STR</code>. To do this in a
unix environment (Linux or OSX), run the following command
</p>

<pre class="example">
export CAN_PG_CONN_STR="postgresql://postgres:postgres_test@localhost:5432"
</pre>

<p>
If you are using Windows, set the environment variable by running
</p>

<pre class="example">
set CAN_PG_CONN_STR="postgresql://postgres:postgres_test@localhost:5432"
</pre>

<p>
With the environment variable set, you can repeat the <code>pytest</code> commands from above
</p>
</div>
</li></ol>
</div>
</div>

<div id="outline-container-sec-5-3" class="outline-3">
<h3 id="sec-5-3"><span class="section-number-3">5.3</span> Setting up VS Code</h3>
<div class="outline-text-3" id="text-5-3">
<p>
Steps to set up VS code:
</p>

<ul class="org-ul">
<li>Install <code>python</code> and <code>pylance</code> VS code extensions
</li>
<li>Reload vs code window
</li>
<li>Open <code>can-scrapers</code> directory in VS code
</li>
<li>Select the <code>can-tools</code> conda environment as the workspace interpreter.
</li>
</ul>

<p>
Please do not push any changes made to the <code>.vscode</code> directory. That has some
shared settings, but will also be overwritten by the absolute path to the
conda environment on your machine. This path is unlikely to match exactly
with the path for any other team members
</p>
</div>
</div>
</div>

<div id="outline-container-sec-6" class="outline-2">
<h2 id="sec-6"><span class="section-number-2">6</span> Scraper Library</h2>
<div class="outline-text-2" id="text-6">
<p>
The scrapers are defined by 4 operations:
</p>

<ol class="org-ol">
<li>Fetch: Retrieves raw data from dashboard
</li>
<li>Normalize: Ingests raw data and spits out normalized data
</li>
<li>Validate: Makes sure that the new normalized data is sensible
</li>
<li>Put: Puts data into our database
</li>
</ol>


<figure id="fig:CANSRAPERS">
<p><img src="static/CAN_scrapers.png" class="img-responsive" alt="CAN_scrapers.png">
</p>
<figcaption><span class="figure-number">Figure 2:</span> Scraper flow chart</figcaption>
</figure>
</div>

<div id="outline-container-sec-6-1" class="outline-3">
<h3 id="sec-6-1"><span class="section-number-3">6.1</span> <code>DatasetBase</code> and relevant subclasses</h3>
<div class="outline-text-3" id="text-6-1">
</div><div id="outline-container-sec-6-1-1" class="outline-4">
<h4 id="sec-6-1-1"><span class="section-number-4">6.1.1</span> <code>DatasetBase</code></h4>
<div class="outline-text-4" id="text-6-1-1">
<p>
This is the most important base class and all scrapers will inherit from it (as their last parent).
</p>

<p>
It is found in <code>can-scrapers/can_tools/scrapers/base.py</code>
</p>

<p>
<b>Methods that must be defined</b>:
</p>

<ul class="org-ul">
<li><code>fetch</code>
</li>
<li><code>normalize</code>
</li>
</ul>

<p>
<b>Methods that you are likely to use*</b>
</p>

<ul class="org-ul">
<li><code>_retrieve_vintage</code>
</li>
<li><code>_retrieve_dt</code>
</li>
<li><code>extract_CMU</code>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-6-1-2" class="outline-4">
<h4 id="sec-6-1-2"><span class="section-number-4">6.1.2</span> <code>StateDashboard</code> or <code>CountyDashboard</code></h4>
<div class="outline-text-4" id="text-6-1-2">
<p>
This is another class that you are likely to use and is used when we don't have another subclass that specializes in extracting data from that particular dashboard
</p>

<p>
It is found in <code>can-scrapers/can_tools/scrapers/official/base.py</code>
</p>
</div>
</div>

<div id="outline-container-sec-6-1-3" class="outline-4">
<h4 id="sec-6-1-3"><span class="section-number-4">6.1.3</span> <code>ArcGIS</code></h4>
<div class="outline-text-4" id="text-6-1-3">
<p>
This subclass specializes in extracting information from an ArcGIS dashboard (which are most of the current scrapers).
</p>

<p>
<b>Properties that must be defined</b>
</p>

<ul class="org-ul">
<li><code>ARCGIS_ID</code>
</li>
</ul>

<p>
<b>Methods that you are likely to use</b>
</p>

<ul class="org-ul">
<li><code>get_all_jsons</code>
</li>
<li><code>arcgis_jsons_to_df</code>
</li>
</ul>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-7" class="outline-2">
<h2 id="sec-7"><span class="section-number-2">7</span> Writing a new scraper</h2>
<div class="outline-text-2" id="text-7">
<p>
As seen in <a href="#sec-6">Scraper Library</a>, a scraper requires 4 methods:
</p>

<ol class="org-ol">
<li><code>fetch</code>
</li>
<li><code>normalize</code>
</li>
<li><code>validate</code>
</li>
<li><code>put</code>
</li>
</ol>

<p>
Most scrapers will <b>not</b> require one to write the <code>validate</code> or <code>put</code> methods
because the generic methods should be able to validate the data and dump it into
the database
</p>
</div>
</div>

<div id="outline-container-sec-8" class="outline-2">
<h2 id="sec-8"><span class="section-number-2">8</span> Example Scrapers</h2>
<div class="outline-text-2" id="text-8">
<ul class="org-ul">
<li><a href="../can_tools/scrapers/official/CA/ca_state.py">California State Dashboard Scraper (API Query)</a>
</li>
<li><a href="../can_tools/scrapers/official/FL/fl_state.py">Florida State Dashboard Scraper (ArcGIS)</a>
</li>
</ul>
</div>
</div>
</div></div></div>
<footer id="postamble" class="">
<div><p class="date">Created: 2020-12-09 Wed 10:39</p>
<p class="creator"><a href="http://www.gnu.org/software/emacs/">Emacs</a> 27.1 (<a href="http://orgmode.org">Org-mode</a> 9.4)</p>
</div>
</footer>
</body>
</html>
